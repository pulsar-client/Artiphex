
-- Persistent Flicker Ability (Recolored Black & White)
-- Teleports around the nearest target.

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local RunService = game:GetService("RunService")
local player = Players.LocalPlayer

-- // --- CONFIGURATION --- \\ --
local ABILITY_CONFIG = {
    Name = "Flicker",
    CooldownLength = 4,
    Burning = false,
    DefaultKey = "5" -- You can change this
}

-- // --- HELPER FUNCTIONS --- \\ --
local function GetNearestTarget(character, range)
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end
    
    local nearest = nil
    local dist = range or 100
    
    -- TSB uses 'workspace.Live' for characters usually
    local container = workspace:FindFirstChild("Live") or workspace
    
    for _, v in pairs(container:GetChildren()) do
        if v ~= character and v:FindFirstChild("HumanoidRootPart") and v:FindFirstChild("Humanoid") then
            local targetHRP = v.HumanoidRootPart
            local mag = (targetHRP.Position - hrp.Position).Magnitude
            if mag < dist then
                dist = mag
                nearest = v
            end
        end
    end
    return nearest
end

local function RecolorToBW(instance)
    for _, v in pairs(instance:GetDescendants()) do
        if v:IsA("ParticleEmitter") then
            -- Set to Black/White Gradient
            v.Color = ColorSequence.new{
                ColorSequenceKeypoint.new(0.00, Color3.new(0,0,0)), -- Black
                ColorSequenceKeypoint.new(1.00, Color3.new(1,1,1))  -- White
            }
        elseif v:IsA("Light") then
            v.Color = Color3.new(1,1,1) -- White Light
        elseif v:IsA("BasePart") then
            v.Color = Color3.new(0,0,0) -- Black Parts
        end
    end
end

-- // --- MAIN ABILITY LOGIC --- \\ --
local function ActivateAbility(character)
    local humanoid = character:WaitForChild("Humanoid")
    local hrp = character:WaitForChild("HumanoidRootPart")
    local target = GetNearestTarget(character, 50)
    
    if not target then return end -- No target found
    
    local targetHRP = target:FindFirstChild("HumanoidRootPart")
    local camera = workspace.CurrentCamera
    
    -- 1. Animation
    local Anim = Instance.new("Animation")
    Anim.AnimationId = "rbxassetid://18897115785"
    -- Use Animator for Delta stability
    local animator = humanoid:FindFirstChild("Animator") or humanoid
    local k = animator:LoadAnimation(Anim)
    k.Priority = Enum.AnimationPriority.Action4
    k:Play()
    k:AdjustSpeed(2)
    
    -- 2. Visual Effects (Fang Flash)
    local success, vp = pcall(function() 
        return ReplicatedStorage.Resources.Fang.FLASH:Clone() 
    end)
    
    if success and vp then
        vp.Parent = workspace
        vp.flashstep.Anchored = true
        
        -- Recolor to Black & White
        RecolorToBW(vp)
        
        local he = vp.flashstep.Attachment
        
        -- Emit particles
        if he:FindFirstChild("wave") then he.wave:Emit(1) end
        if he:FindFirstChild("black") then he.black:Emit(1) end
        if he:FindFirstChild("flash") then he.flash:Emit(1) end
        
        -- Cleanup visual
        task.delay(5, function() vp:Destroy() end)
        
        -- 3. Teleport Sequence
        camera.CameraSubject = target
        
        -- Create Custom Particle Trail (Monochrome)
        local pm = Instance.new("ParticleEmitter")
        pm.Parent = hrp
        pm.ZOffset = 0
        pm.LockedToPart = true
        pm.Size = NumberSequence.new{
            NumberSequenceKeypoint.new(0, 0),
            NumberSequenceKeypoint.new(.5, 5),
            NumberSequenceKeypoint.new(1, 2)
        }
        pm.Brightness = 0
        pm.LightEmission = 0
        pm.Lifetime = NumberRange.new(.1)
        pm.Rate = 0
        pm.Texture = "rbxassetid://10184824645"
        pm.Color = ColorSequence.new(Color3.new(1,1,1)) -- White Trail
        
        local originalCFrame = hrp.CFrame
        
        -- Teleport Loop
        for i = 1, 60 do -- Shortened slightly for responsiveness
            if not target.Parent then break end
            
            -- Visual Anchor
            vp.flashstep.CFrame = originalCFrame * CFrame.new(0, -2.5, 0)
            
            -- Emit Trail
            pm:Emit(1)
            
            -- Teleport Math (Circling)
            hrp.CFrame = targetHRP.CFrame 
                * CFrame.new(math.sin(i*-2.5)*25, 0, math.cos(i*-2.5)*25)
                * CFrame.Angles(0, math.rad(-90) + i*-2.5, 0)
            
            RunService.RenderStepped:Wait()
        end
        
        -- End Sequence
        camera.CameraSubject = character
        k:Stop()
        pm:Destroy()
        -- Teleport behind target
        hrp.CFrame = targetHRP.CFrame * CFrame.new(0, 0, 5)
    else
        warn("Resources.Fang.FLASH not found - Check game assets")
        k:Stop()
    end
end

-- // --- SETUP FUNCTION --- \\ --
local function SetupAbility(character)
    local backpack = player:WaitForChild("Backpack")
    local playerGui = player:WaitForChild("PlayerGui")
    local humanoid = character:WaitForChild("Humanoid")
    
    if backpack:FindFirstChild(ABILITY_CONFIG.Name) then return end
    
    local SkillTool = Instance.new("Tool")
    SkillTool.Name = ABILITY_CONFIG.Name
    SkillTool.RequiresHandle = false
    SkillTool.CanBeDropped = false
    SkillTool.Parent = backpack

    local OnCooldown = false
    local CurrentKey = ABILITY_CONFIG.DefaultKey
    local InputConnection = nil

    local function TriggerCooldown()
        OnCooldown = true
        -- (Simplified Cooldown Visuals for brevity - same as template)
        task.delay(ABILITY_CONFIG.CooldownLength, function() OnCooldown = false end)
        
        -- Attempt Visuals
        local hotbar = playerGui:FindFirstChild("Hotbar", true)
        if hotbar then
            for _, slot in pairs(hotbar:GetDescendants()) do
                if slot:IsA("TextLabel") and slot.Text == ABILITY_CONFIG.Name then
                    local cd = Instance.new("Frame", slot.Parent) -- Simple fallback
                    cd.Size = UDim2.new(1,0,1,0)
                    cd.BackgroundColor3 = Color3.new(0,0,0)
                    cd.BackgroundTransparency = 0.5
                    TweenService:Create(cd, TweenInfo.new(ABILITY_CONFIG.CooldownLength), {Size = UDim2.new(1,0,0,0)}):Play()
                    task.delay(ABILITY_CONFIG.CooldownLength, function() cd:Destroy() end)
                    break
                end
            end
        end
    end

    -- Hook Tool Activation (Click)
    SkillTool.Activated:Connect(function()
        if not OnCooldown then
            TriggerCooldown()
            ActivateAbility(character)
        end
    end)

    -- Hook Keybinds
    InputConnection = UserInputService.InputBegan:Connect(function(input, gp)
        if gp then return end
        local KeyMap = {["1"]=Enum.KeyCode.One, ["2"]=Enum.KeyCode.Two, ["3"]=Enum.KeyCode.Three, ["4"]=Enum.KeyCode.Four, ["5"]=Enum.KeyCode.Five}
        local targetKey = KeyMap[CurrentKey] or Enum.KeyCode[ABILITY_CONFIG.DefaultKey]
        
        if input.KeyCode == targetKey and not OnCooldown then
            TriggerCooldown()
            ActivateAbility(character)
        end
    end)

    humanoid.Died:Connect(function()
        if InputConnection then InputConnection:Disconnect() end
    end)
end

player.CharacterAdded:Connect(SetupAbility)
if player.Character then SetupAbility(player.Character) end
