-------------------------------
-- ORBITAL GAZER (EXTRACTED) --
-------------------------------

local SkillName = "Orbital Gazer"
local CooldownLengh = 4
local Burning = false -- not used, leave as-is

-- == ORBITAL GAZER CODE ==
local function OrbitalGazer()
    local lp = game.Players.LocalPlayer
    local char = lp.Character
    local hrp = char:FindFirstChild("HumanoidRootPart")
    if not hrp then return end

    task.spawn(function()
        local gothit = false
        for _,v in pairs(workspace.Live:GetChildren()) do 
            local tor = v:FindFirstChild("Torso")
            local hum = v:FindFirstChildOfClass("Humanoid")
            if tor and hum and v ~= char then
                if (tor.Position - hrp.Position).Magnitude <= 33 then
                    if gothit then return end
                    gothit = true
                    task.delay(5, function() gothit = false end)

                    workspace.CurrentCamera.CameraSubject = v

                    -- Animation 1
                    local Anim = Instance.new("Animation")
                    Anim.AnimationId = "rbxassetid://18897115785"
                    local k = char.Humanoid:LoadAnimation(Anim)
                    k.Priority = Enum.AnimationPriority.Action4
                    k:Play()
                    k:AdjustSpeed(2)

                    -- Flash effect
                    local vp = game.ReplicatedStorage.Resources.Fang.FLASH:Clone()
                    vp.Parent = workspace
                    vp.flashstep.Anchored = true
                    vp.flashstep.Attachment.black:Emit(1)
                    vp.flashstep.Attachment.flash:Emit(1)

                    -- Orbit
                    local pm = Instance.new("ParticleEmitter")
                    pm.Parent = hrp
                    pm.Texture = "rbxassetid://10184824645"
                    pm.Lifetime = NumberRange.new(0.1)
                    pm.Rate = 0
                    pm.LockedToPart = true

                    for i = 1,150 do
                        if char:FindFirstChild("Freeze") or char:FindFirstChild("Slowed") or char:FindFirstChild("AntiMove") then break end

                        vp.flashstep.CFrame = hrp.CFrame * CFrame.new(0, -2.5, 0)
                        vp.flashstep.Attachment.black:Emit(1)
                        vp.flashstep.Attachment.flash:Emit(1)
                        pm:Emit(1)

                        hrp.CFrame = v.HumanoidRootPart.CFrame
                            * CFrame.new(math.sin(i * -2.5) * 25, 0, math.cos(i * -2.5) * 25)
                            * CFrame.Angles(0, math.rad(-90) + i * -2.5, 0)

                        task.wait()
                    end

                    workspace.CurrentCamera.CameraSubject = char
                    k:Stop()
                    pm:Destroy()
                    hrp.CFrame = v.HumanoidRootPart.CFrame * CFrame.new(0, 0, 5)
                end
            end
        end
    end)
end

-- ==========================================
-- CONNECT ORBITAL GAZER TO TEMPLATE SYSTEM
-- ==========================================

local Activated = function()
    OrbitalGazer()
end

-- == THE TEMPLATE CODE ITSELF ==
local SkillTemplate = Instance.new("Tool")
SkillTemplate.Name = SkillName
SkillTemplate.RequiresHandle = false
SkillTemplate.ManualActivationOnly = false
SkillTemplate.CanBeDropped = false
SkillTemplate:SetAttribute("Regged", false)
SkillTemplate:SetAttribute("Skill", true)
SkillTemplate.Parent = game.Players.LocalPlayer.Backpack

local ks = "5"
local OnCooldown = false

local function cooldownFunction()
    OnCooldown = true
    local cd = game.Players.LocalPlayer.PlayerGui.Hotbar.Backpack.LocalScript.Cooldown:Clone()

    for _, slot in pairs(game.Players.LocalPlayer.PlayerGui.Hotbar.Backpack.Hotbar:GetDescendants()) do
        if slot:IsA("TextLabel") and slot.Name == "ToolName" and slot.Text == SkillName then
            ks = slot.Parent.Parent.Name
            cd.Parent = slot.Parent

            local tween = game.TweenService:Create(cd, TweenInfo.new(CooldownLengh), {Size = UDim2.new(1,0,-0.12,0)})
            tween:Play()
            tween.Completed:Connect(function()
                OnCooldown = false
                cd:Destroy()
            end)
        end
    end
end

-- UI clicking support
for _, slot in pairs(game.Players.LocalPlayer.PlayerGui.Hotbar.Backpack.Hotbar:GetDescendants()) do
    if slot:IsA("TextLabel") and slot.Name == "ToolName" and slot.Text == SkillName then
        slot.Parent.MouseButton1Click:Connect(function()
            if not OnCooldown then
                cooldownFunction()
                Activated()
            end
        end)
    end
end

-- Keyboard activation
local KeyMap = {
    ["1"] = Enum.KeyCode.One, ["2"] = Enum.KeyCode.Two, ["3"] = Enum.KeyCode.Three,
    ["4"] = Enum.KeyCode.Four,["5"] = Enum.KeyCode.Five,["6"] = Enum.KeyCode.Six,
    ["7"] = Enum.KeyCode.Seven,["8"] = Enum.KeyCode.Eight,["9"] = Enum.KeyCode.Nine,
    ["0"] = Enum.KeyCode.Zero
}

local uis = game:GetService("UserInputService")
local kb = KeyMap[ks]

local inputConn = uis.InputBegan:Connect(function(input)
    if input.KeyCode == kb then
        if not OnCooldown then
            cooldownFunction()
            Activated()
        end
    end
end)

-- RE-SPAWN FIX: Recreate skill after death
game.Players.LocalPlayer.Character.Humanoid.Died:Connect(function()
    task.wait(0.5)
    SkillTemplate.Parent = game.Players.LocalPlayer.Backpack
end)            local mag = (targetHRP.Position - hrp.Position).Magnitude
            if mag < dist then
                dist = mag
                nearest = v
            end
        end
    end
    return nearest
end


-- // --- MAIN ABILITY LOGIC (VOLTA Orbital Gazer) --- \\ --
local function ActivateAbility(character)
    local humanoid = character:WaitForChild("Humanoid")
    local hrp = character:WaitForChild("HumanoidRootPart")
    local target = GetNearestTarget(character, 50)
    
    if not target or not target.Parent then return end -- No target found or target despawned
    
    local targetHRP = target:FindFirstChild("HumanoidRootPart")
    if not targetHRP then return end
    
    local camera = workspace.CurrentCamera
    local animator = humanoid:FindFirstChild("Animator") or humanoid
    
    -- 1. Animation (Orbital Gazer Start)
    local Anim = Instance.new("Animation")
    Anim.AnimationId = "rbxassetid://18897115785"
    local k = animator:LoadAnimation(Anim)
    k.Priority = Enum.AnimationPriority.Action4
    k:Play()
    k:AdjustSpeed(2) -- Faster execution
    
    -- 2. Visuals (Fang Flash)
    local success, vp = pcall(function() 
        return ReplicatedStorage.Resources.Fang.FLASH:Clone() 
    end)
    
    if success and vp then
        vp.Parent = workspace
        vp.flashstep.Anchored = true
        Debris:AddItem(vp, 5) -- Add cleanup
        
        local he = vp.flashstep.Attachment
        
        -- Emit particles (Original VOLTA particles)
        if he:FindFirstChild("wave") then he.wave:Emit(1) end
        if he:FindFirstChild("black") then he.black:Emit(1) end
        if he:FindFirstChild("flash") then he.flash:Emit(1) end
        
        -- 3. Teleport Sequence
        camera.CameraSubject = target -- Lock camera to target for cinematic effect
        
        -- Custom Particle Trail (Original)
        local pm = Instance.new("ParticleEmitter")
        pm.Parent = hrp
        pm.ZOffset = 0
        pm.LockedToPart = true
        pm.Size = NumberSequence.new{
            NumberSequenceKeypoint.new(0, 0),
            NumberSequenceKeypoint.new(.5, 5),
            NumberSequenceKeypoint.new(1, 2)
        }
        pm.Brightness = 0
        pm.LightEmission = 0
        pm.Lifetime = NumberRange.new(.1)
        pm.Rate = 0
        pm.Texture = "rbxassetid://10184824645"
        pm.Color = ColorSequence.new(Color3.new(1,0,0)) -- Red trail (Original)
        Debris:AddItem(pm, 5)
        
        local originalCFrame = hrp.CFrame
        
        -- Teleport Loop (60 iterations around target)
        for i = 1, 60 do 
            if not target.Parent then break end
            
            vp.flashstep.CFrame = originalCFrame * CFrame.new(0, -2.5, 0)
            pm:Emit(1)
            
            -- VOLTA's specific orbital math
            hrp.CFrame = targetHRP.CFrame 
                * CFrame.new(math.sin(i*-2.5)*25, 0, math.cos(i*-2.5)*25)
                * CFrame.Angles(0, math.rad(-90) + i*-2.5, 0)
            
            RunService.RenderStepped:Wait()
        end
        
        -- 4. Cleanup and Final Position
        camera.CameraSubject = character -- Restore camera to player
        k:Stop()
        pm:Destroy()
        -- Teleport behind target for final hit/stance
        hrp.CFrame = targetHRP.CFrame * CFrame.new(0, 0, 5)
        
    else
        warn("Resources.Fang.FLASH not found - Unable to run visual effect.")
    end
end

-- // --- SETUP FUNCTION (PERSISTENT TEMPLATE) --- \\ --
local function SetupAbility(character)
    local backpack = player:WaitForChild("Backpack")
    local playerGui = player:WaitForChild("PlayerGui")
    local humanoid = character:WaitForChild("Humanoid")
    
    if backpack:FindFirstChild(ABILITY_CONFIG.Name) then return end
    
    local SkillTool = Instance.new("Tool")
    SkillTool.Name = ABILITY_CONFIG.Name
    SkillTool.RequiresHandle = false
    SkillTool.CanBeDropped = false
    SkillTool.Parent = backpack

    local OnCooldown = false
    local CurrentKey = ABILITY_CONFIG.DefaultKey
    local InputConnection = nil

    local function TriggerCooldown()
        OnCooldown = true
        
        -- Cooldown Visuals (Simplified version)
        task.delay(ABILITY_CONFIG.CooldownLength, function() OnCooldown = false end)
        
        local hotbar = playerGui:FindFirstChild("Hotbar", true)
        if hotbar then
            for _, slot in pairs(hotbar:GetDescendants()) do
                if slot:IsA("TextLabel") and slot.Text == ABILITY_CONFIG.Name then
                    local cd = Instance.new("Frame", slot.Parent) 
                    cd.Size = UDim2.new(1,0,1,0)
                    cd.BackgroundColor3 = Color3.fromRGB(150, 0, 0) -- Red cooldown color
                    cd.BackgroundTransparency = 0.5
                    TweenService:Create(cd, TweenInfo.new(ABILITY_CONFIG.CooldownLength), {Size = UDim2.new(1,0,0,0)}):Play()
                    task.delay(ABILITY_CONFIG.CooldownLength, function() cd:Destroy() end)
                    break
                end
            end
        end
    end

    -- Hook Tool Activation (Click)
    SkillTool.Activated:Connect(function()
        if not OnCooldown and character.Parent then
            TriggerCooldown()
            ActivateAbility(character)
        end
    end)

    -- Hook Keybinds
    InputConnection = UserInputService.InputBegan:Connect(function(input, gp)
        if gp then return end
        
        -- Basic Key Mapping (1-5)
        local KeyMap = {["1"]=Enum.KeyCode.One, ["2"]=Enum.KeyCode.Two, ["3"]=Enum.KeyCode.Three, ["4"]=Enum.KeyCode.Four, ["5"]=Enum.KeyCode.Five}
        local targetKey = KeyMap[CurrentKey] or Enum.KeyCode[ABILITY_CONFIG.DefaultKey]
        
        if input.KeyCode == targetKey and not OnCooldown and character.Parent then
            TriggerCooldown()
            ActivateAbility(character)
        end
    end)

    -- Cleanup on Death
    humanoid.Died:Connect(function()
        if InputConnection then 
            InputConnection:Disconnect() 
        end
    end)
end

-- // --- INITIALIZATION --- \\ --
player.CharacterAdded:Connect(SetupAbility)
if player.Character then SetupAbility(player.Character) end
